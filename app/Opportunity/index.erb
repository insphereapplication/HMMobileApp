<style type="text/css">
	/* set the selected tab's div to visible */
	div#<%= @params['selected_tab'] %> {
		display: block;
	}
</style>

<script type='text/javascript'>
	function toggleFilterArea(tab)
	{
		toggleDiv(tab+'_filter'); 
		toggleDiv(tab+'_minus');
		toggleDiv(tab+'_plus');
	}
	
	function showFilterParams(filter, span){
		filterparams = '<span id="'+span+ '-filter-params" style="margin-top:5px;font-size:12px;">Filter: ' + filter +'</span>'
		$('#'+span+'-filter-params').remove();
		$('#'+span+'-filter-details').append( filterparams );
	}
	
	function getSelectedText(span, select){
		filter = document.getElementById(span+'_'+select+'_filter');
		selected_index = filter.selectedIndex;
		filter_text = filter.options[selected_index].text;
		return filter_text		
	}
	
	function checkDateForPageRefresh()
	{
		var currentDateTime = new Date();
		var currentDate = currentDateTime.getDate();
		if (lastRefreshedDate != currentDate)
		{
			location.reload(true);
		}
		
	}

	function pollDateRefreshStatus(interval_ms)
	{
		checkDateForPageRefresh();
		setTimeout("pollDateRefreshStatus("+ interval_ms +")",interval_ms);
	}
	
	function refreshFollowupFilterSummary()
	{
		filter_status=getSelectedText('followup','status_reason');
		sort_by_status=getSelectedText('followup','sort_by');
		created_status=getSelectedText('followup','created');
                var isDaily = $('#followup_daily_filter').attr('checked') ? ", Daily" : "";
		filter=filter_status+', '+sort_by_status+', '+created_status+isDaily;
		showFilterParams(filter, 'followup');
	}
	
	function refreshAppointmentFilterSummary()
	{
		appointments_filter=getSelectedText('appointments','select')
		input = $('#appointments_search_input').val();
		filter=appointments_filter+', "'+input+'"'
		showFilterParams(filter, 'scheduled');
	}
	
	function getDailyFilterValue()
	{
		return $('#followup_daily_filter').attr('checked') ? 'true' : 'false';
	}
	
	$(document).ready(function() {
		// add the selected style to the selected tab button
		$('a#<%= @params['selected_tab'] %>-button').addClass('ui-btn-active');
		
		// disable the filter buttons while page is loading
		disableFilters('follow-ups');
		disableFilters('scheduled');
				
		loadNewLeads(); 
		loadFollowUps( $('#followup_status_reason_filter').val(), $('#followup_sort_by_filter').val(), $('#followup_created_filter').val(), getDailyFilterValue() );
		loadScheduled( $('#appointments_select_type_filter').val(), $('#appointments_select_date_filter').val() );
	
		$('#followup_filter_button').click( function()
		{
			if(filteringEnabled('follow-ups'))
			{
				disableFilters('follow-ups');
				toggleFilterArea('followup');
				refreshFollowupFilterSummary();
				loadFollowUps( $('#followup_status_reason_filter').val(), $('#followup_sort_by_filter').val(), $('#followup_created_filter').val(), getDailyFilterValue() );
			}
			return false;
		});
		
		$(document).on('click', '#followup_clear' ,function()
		{
			if(filteringEnabled('follow-ups'))
			{
				disableFilters('follow-ups');
				$('#followup_status_reason_filter').val('All');
				$('#followup_sort_by_filter').val('LastActivityDateAscending');
				$('#followup_created_filter').val('All');
                                $('#followup_daily_filter').removeAttr('checked');
				refreshFollowupFilterSummary();
				loadFollowUps( $('#followup_status_reason_filter').val(), $('#followup_sort_by_filter').val(), $('#followup_created_filter').val(), getDailyFilterValue() );
			}
			return false;
		});

		$(document).on('click', '#appointments_clear', function()
		{
			if(filteringEnabled('scheduled'))
			{
				disableFilters('scheduled');
				$('#appointments_select_type_filter').val('All');
				$('#appointments_select_date_filter').val('All');
				refreshAppointmentFilterSummary();
				loadScheduled( $('#appointments_select_type_filter').val(), $('#appointments_select_date_filter').val() );
			}
			return false;
		});

		$(document).on('click', '#appointments_filter_button',function()
		{
			if(filteringEnabled('scheduled'))
			{
				disableFilters('scheduled');
				toggleFilterArea('appointments');
				refreshAppointmentFilterSummary();
				loadScheduled( $('#appointments_select_type_filter').val(), $('#appointments_select_date_filter').val() );
			}
			return false;
		});
		
		refreshFollowupFilterSummary();
		refreshAppointmentFilterSummary();
		
		// enable the filter buttons after page is loaded
		disableFilters('follow-ups');
		disableFilters('scheduled');
	});

	var tempDate = new Date();
	lastRefreshedDate = tempDate.getDate();
 	pollDateRefreshStatus(60000);

</script>

<div  data-theme="a" data-role="page">
	<%= offline_bar%>
	<div data-nobackbtn="true" data-role="header" data-theme="a"  >
		<a href="<%= url_for(:action => :contact_opp_new, :query =>{:origin => @params['selected_tab']})%>" data-icon="plus" data-transition="none">Create
		</a>
		<h1 class="ui-title" tabindex="0" role="heading" aria-level="1">Opportunities
		<%= sync_spinner %>
		</h1>
	</div>
	<div data-role="navbar" >
		<ul>
			<li >
				<a id="new-leads-button" class="tab-button ui-btn ui-btn-up-a " data-transition="none" data-theme="a">New Leads</a>
			</li>
			<li >
				<a id="follow-ups-button" class="tab-button ui-btn ui-btn-up-a" data-transition="none" data-theme="a">Follow-Up</a>
			</li>
			<li >
				<a id="appointments-button" class="tab-button ui-btn ui-btn-up-a" data-transition="none" data-theme="a">Scheduled</a>
			</li>
		</ul>
	</div>
	<div id="new-leads" data-role="content" class="ui-content opp-tab" role="main">
		<ul id="new-leads-list"  data-theme="a" data-role="listview" >
		   <li data-role="list-divider">Today</li>
		    <% todays = Opportunity.todays_new_leads %>
          <%= render :partial => 'opportunity', :locals => { :items => todays, :origin => 'new-leads', :selected_tab => 'new-leads' } %>
       <li data-role="list-divider">Past Due</li>
          <% past = Opportunity.previous_days_leads %>
          <% puts '####### OPP #{Opportunity.previous_days_leads}' %>
                   <%= render :partial => 'opportunity', :locals => { :items => past, :origin => 'new-leads', :selected_tab => 'new-leads' } %>
		</ul>
	</div>	
</div>


	
